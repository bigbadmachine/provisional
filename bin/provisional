#!/usr/bin/env ruby

require 'rubygems'
require 'provisional'
require 'provisional/version'
require 'trollop'
require 'active_support'

opts = Trollop::options do
  version "Provisional #{Provisional::Version}"
  opt :name, "Name of the project", :type => String
  opt :scm, "SCM to use (git or svn)", :type => String, :default => 'git'
  opt :rails, "Path to rails generator script", :type => String, :default => `which rails`.chomp
  opt :template, "Rails template to use", :type => String, :default => 'viget'
end

opts[:template_path] = File.join(File.dirname(__FILE__),'..','lib','provisional','templates',"#{opts[:template]}.rb")

Trollop::die(:name, "must be specified") unless opts[:name]
Trollop::die(:scm, "is not supported: #{opts[:scm]}") unless %w(git svn).include?(opts[:scm])
Trollop::die(:rails, "must be specified") if opts[:rails].to_s.empty?
Trollop::die(:rails, "is not valid: #{opts[:rails]}") unless File.exist?(opts[:rails]) && File.executable?(opts[:rails])
Trollop::die(:template, "is not valid: #{opts[:template]}") unless File.exist?(opts[:template_path])

require "provisional/scm/#{opts[:scm]}"
scm = "Provisional::SCM::#{opts[:scm].classify}".constantize.new(opts)

system scm.init
system scm.generate_rails
system scm.checkin
